{% extends "carteira/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container py-4">

  <!-- HERO / BREADCRUMB + A√á√ïES -->
  <div class="dashboard-hero">
    <div class="d-flex flex-column gap-2">
      <nav class="small">
        <a class="text-white-50" href="{% url 'carteira:dashboard' %}">In√≠cio</a>
        <span class="text-white-50">/</span>
        <span class="text-white fw-semibold">Exclu√≠dos</span>
      </nav>

      <div class="row g-2 align-items-center">
        <div class="col-12 col-lg-6">
          <h5 class="title mb-0">üóëÔ∏è Contas exclu√≠das</h5>
        </div>
        <div class="col-12 col-lg-6">
          <form method="get" class="d-flex search-box" action=".">
            <input type="search"
                   class="form-control form-control-lg me-2"
                   name="q"
                   id="excluidos-search"
                   value="{{ q|default:'' }}"
                   placeholder="Buscar por cliente‚Ä¶"
                   autocomplete="off">
            <button class="btn btn-light" type="submit">Buscar</button>
          </form>
        </div>
      </div>

      <div class="top-actions d-flex gap-2 mt-2">
        <a href="{% url 'carteira:dashboard' %}" class="btn btn-outline-light">
          Voltar ao dashboard
        </a>
      </div>
    </div>
  </div>

  {% if contas %}
  <div class="section-card">
    <div class="card-header"><h4>Registros</h4></div>
    <div class="card-body">
      <div class="table-wrap">
        <table class="table table-striped table-sm table-bordered table-hover align-middle mb-0">
          <thead>
            <tr>
              <th class="text-center">#</th>
              <th>Cliente</th>
              <th class="text-center">Criado em</th>
              <th class="text-center">Vencimento</th>
              <th class="text-end">Total</th>
              <th class="text-end">Saldo</th>
              <th class="text-center">Status</th>
              <th class="text-center">Exclu√≠da em</th>
              <th>Motivo</th>
              <th>Exclu√≠da por</th>
              <th class="text-center">#</th>
            </tr>
          </thead>
          <tbody>
            {% for c in contas %}
            <tr>
              <th class="text-center">{{ c.id }}</th>
              <td>{{ c.cliente.nome }}</td>
              <td class="text-center">{{ c.criado_em|date:"d/m/Y" }}</td>
              <td class="text-center">
                {% if c.vencimento %}{{ c.vencimento|date:"d/m/Y" }}{% else %}‚Äî{% endif %}
              </td>
              <td class="text-end">R$ {{ c.total|floatformat:2|intcomma }}</td>
              <td class="text-end">R$ {{ c.saldo|floatformat:2|intcomma }}</td>
              <td class="text-center">
                <span class="badge bg-{% if c.status == 'PAGO' %}success{% elif c.status == 'ATRASO' %}danger{% else %}warning text-dark{% endif %}">
                  {{ c.get_status_display }}
                </span>
              </td>
              <td class="text-center">{{ c.deleted_at|date:"d/m/Y H:i" }}</td>
              <td>{{ c.deleted_reason|default:"‚Äî" }}</td>
              <td>{{ c.deleted_by.get_username|default:"‚Äî" }}</td>
              <td class="text-center row-actions">
                <button type="button"
                        class="btn btn-sm btn-outline-dark"
                        data-bs-toggle="modal"
                        data-bs-target="#modalRestaurarConta"
                        data-url="{% url 'carteira:restaurar_conta' c.id %}"
                        data-label="Conta #{{ c.id }} ‚Äî {{ c.cliente.nome }}">
                  Restaurar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
    <div class="section-card">
      <div class="card-header"><h4>Registros</h4></div>
      <div class="card-body p-3">
        <div class="alert alert-info mb-0">
          Nenhuma conta exclu√≠da encontrada.
        </div>
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
  // Debounce para busca (mesmo comportamento do dashboard)
  (function () {
    const input = document.getElementById('excluidos-search');
    if (!input) return;
    let t = null;
    input.addEventListener('input', function () {
      clearTimeout(t);
      t = setTimeout(() => {
        const form = input.closest('form');
        if (form) form.submit();
      }, 400);
    });
  })();
</script>

<!-- Modal Restaurar Conta -->
<div class="modal fade" id="modalRestaurarConta" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-themed new">
      <form id="formRestaurarConta" method="post" action="#" autocomplete="off">
        {% csrf_token %}

        <!-- iscas anti-autofill -->
        <input type="text" name="fake_username" autocomplete="username" class="d-none" tabindex="-1" aria-hidden="true">
        <input type="password" name="fake_password" autocomplete="new-password" class="d-none" tabindex="-1" aria-hidden="true">

        <div class="modal-header">
          <h5 class="modal-title">‚Ü©Ô∏è Confirmar restaura√ß√£o</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <div class="modal-context">
            A conta ser√° restaurada e voltar√° a aparecer nas listas do dashboard.
          </div>

          <p class="mb-2">
            Deseja restaurar <strong id="restaurar-label"></strong>?
          </p>

          <div class="mb-2">
            <label class="form-label fw-semibold">Digite sua senha para confirmar</label>
            <input type="password"
                   name="senha"
                   id="id_senha_restaurar"
                   class="form-control"
                   required
                   autocomplete="new-password"
                   autocapitalize="off"
                   autocorrect="off"
                   spellcheck="false">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Confirmar restaura√ß√£o</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Bind din√¢mico do modal (mesmo padr√£o dos outros modais)
  document.addEventListener('show.bs.modal', function (event) {
    const modal = event.target;
    if (modal.id !== 'modalRestaurarConta') return;

    const trigger = event.relatedTarget;
    if (!trigger) return;

    const url = trigger.getAttribute('data-url');
    const label = trigger.getAttribute('data-label');

    const form = modal.querySelector('#formRestaurarConta');
    const labelEl = modal.querySelector('#restaurar-label');

    if (form && url) form.setAttribute('action', url);
    if (labelEl && label) labelEl.textContent = label;

    // foco no campo senha
    setTimeout(() => {
      const senha = modal.querySelector('#id_senha_restaurar');
      if (senha) senha.focus();
    }, 200);
  });
</script>
{% endblock %}
