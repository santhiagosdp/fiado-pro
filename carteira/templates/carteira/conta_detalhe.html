{% extends "carteira/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container py-4">

  <div class="dashboard-hero">
    <div class="d-flex flex-column gap-2">
      <nav class="small">
        <a class="text-white-50" href="{% url 'carteira:dashboard' %}">InÃ­cio</a>
        <span class="text-white-50">/</span>
        <span class="text-white-50">Conta</span>
        <span class="text-white-50">/</span>
        <span class="text-white fw-semibold">Detalhes</span>
      </nav>

      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2">
        <h5 class="title mb-0">ðŸ§¾ Detalhes da Conta â€” {{ conta.cliente.nome }}</h5>
        <div class="top-actions d-flex gap-2">
          <a href="{% url 'carteira:dashboard' %}" class="btn btn-outline-light">Voltar</a>
          <a href="{% url 'carteira:recibo_conta' conta.id %}?print=1"
             class="btn btn-outline-light" target="_blank" rel="noopener">
            Imprimir 2Âª via
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- ITENS DA VENDA -->
    <div class="col-md-7">
      <div class="section-card">
        <div class="card-header"><h4>Itens da venda</h4></div>
        <div class="card-body">
          <div class="table-wrap">
            <table class="table table-striped table-sm table-bordered table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Produto</th>
                  <th class="text-center">Qtd</th>
                  <th class="text-end">Unit.</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for i in conta.itens.all %}
                <tr>
                  <td>{{ i.produto }}</td>
                  <td class="text-center">{{ i.quantidade }}</td>
                  <td class="text-end">R$ {{ i.valor_unit|floatformat:2|intcomma }}</td>
                  <td class="text-end">R$ {{ i.subtotal|floatformat:2|intcomma }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center text-muted py-3">Nenhum item lanÃ§ado</td></tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="3" class="text-end">Total</th>
                  <th class="text-end">R$ {{ conta.total|floatformat:2|intcomma }}</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- RESUMO + REGISTRAR PAGAMENTO -->
    <div class="col-md-5">
      <div class="section-card">
        <div class="card-header"><h4>Resumo</h4></div>
        <div class="card-body p-3">
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Total</span>
            <strong>R$ {{ conta.total|floatformat:2|intcomma }}</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Saldo</span>
            <strong class="text-{% if conta.saldo > 0 %}danger{% else %}success{% endif %}">
              R$ {{ conta.saldo|floatformat:2|intcomma }}
            </strong>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">Status</span>
            {% if conta.status == 'ATRASO' %}
              <span class="badge bg-danger">Atraso</span>
            {% elif conta.status == 'EM_ABERTO' %}
              <span class="badge bg-warning text-dark">Em aberto</span>
            {% else %}
              <span class="badge bg-success">Pago</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- FORM PAGAMENTO -->
      <div class="section-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Registrar pagamento</h4>
          <button type="button" id="btn-receber-total" class="btn btn-outline-dark btn-sm">
            Receber total
          </button>
        </div>
        <div class="card-body p-3">
          <form id="formPagar" method="post" action="{% url 'carteira:pagar' conta.id %}" target="_blank">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label fw-semibold">Valor</label>
                {{ pgform.valor }}
              </div>
              <div class="col-6">
                <label class="form-label fw-semibold">Data do pagamento</label>
                {{ pgform.data_pagamento }}
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">ObservaÃ§Ã£o</label>
                {{ pgform.observacao }}
              </div>
            </div>
            <div class="text-end mt-3">
              <button class="btn btn-primary">Confirmar pagamento</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

  <!-- HISTÃ“RICO DE PAGAMENTOS -->
  <div class="section-card">
    <div class="card-header"><h4>HistÃ³rico de pagamentos</h4></div>
    <div class="card-body">
      <div class="table-wrap">
        <table class="table table-striped table-sm table-bordered table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Data de cadastro</th>
              <th>Data efetiva</th>
              <th class="text-end">Valor</th>
              <th class="text-center">#</th>
            </tr>
          </thead>
          <tbody>
            {% for p in conta.pagamentos.all %}
            <tr>
              <td>{{ p.data|date:'d/m/Y H:i' }}</td>
              <td>{{ p.data_pagamento|date:'d/m/Y H:i' }}</td>
              <td class="text-end">R$ {{ p.valor|floatformat:2|intcomma }}</td>
              <td class="text-center">
                <a class="btn btn-sm btn-outline-dark"
                   href="{% url 'carteira:recibo_pagamento' p.id %}?print=1"
                   target="_blank" rel="noopener">Recibo</a>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center text-muted py-3">Nenhum pagamento registrado</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const btn = document.getElementById('btn-receber-total');
    if(!btn) return;

    btn.addEventListener('click', function(){
      let valorInput = document.getElementById('id_valor');
      if(!valorInput){
        valorInput = document.querySelector('input[name$="valor"]') || document.querySelector('input[name="valor"]');
      }
      if(!valorInput) return;

      const saldoText = "{{ conta.saldo|floatformat:2|intcomma }}";
      const normalized = saldoText.replace(/\./g,'').replace(',','.');
      valorInput.value = normalized;
      try{ valorInput.focus(); valorInput.select(); }catch(e){}
    });
  })();
</script>
{% endblock %}
