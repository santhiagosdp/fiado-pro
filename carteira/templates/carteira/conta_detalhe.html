{% extends 'carteira/base.html' %}
{% load static %}

{% block content %}

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Detalhes da conta de {{ conta.cliente.nome }}</h3>

  <div class="d-flex gap-2">
    <a href="{% url 'carteira:dashboard' %}" class="btn btn-secondary">Voltar ao dashboard</a>

    <!-- 2ª via do comprovante de venda -->
    <a
      href="{% url 'carteira:recibo_conta' conta.id %}?print=1"
      class="btn btn-outline-primary"
      target="_blank"
      rel="noopener"
      title="Imprimir 2ª via do comprovante de venda">
      Imprimir 2ª via
    </a>
  </div>
</div>


<div class="row">
  <div class="col-md-7">
    <div class="card mb-3">
      <div class="card-header">Itens</div>
      <div class="card-body p-0">
        <table class="table mb-0">
          <thead>
            <tr>
              <th>Produto</th>
              <th class="text-end">Qtd</th>
              <th class="text-end">Unit</th>
              <th class="text-end">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for i in conta.itens.all %}
            <tr>
              <td>{{ i.produto }}</td>
              <td class="text-end">{{ i.quantidade }}</td>
              <td class="text-end">R$ {{ i.valor_unit|floatformat:2 }}</td>
              <td class="text-end">R$ {{ i.subtotal|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-muted">Sem itens</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-end"><strong>Total</strong></td>
              <td class="text-end"><strong>R$ {{ conta.total|floatformat:2 }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <span>Total</span><strong>R$ {{ conta.total|floatformat:2 }}</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>Saldo</span>
          <strong class="text-{% if conta.saldo > 0 %}danger{% else %}success{% endif %}">
            R$ {{ conta.saldo|floatformat:2 }}
          </strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>Status</span>
          {% if conta.status == 'ATRASO' %}
          <span class="badge bg-danger">Atraso</span>
          {% elif conta.status == 'EM_ABERTO' %}
          <span class="badge bg-warning text-dark">Em aberto</span>
          {% else %}
          <span class="badge bg-success">Pago</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Registrar pagamento</div>
      <div class="card-body">
        <form method="post" action="{% url 'carteira:pagar' conta.id %}">
          {% csrf_token %}
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Valor</label>
              {{ pgform.valor }}
            </div>
            <div class="col-6">
              <label class="form-label">Obs</label>
              {{ pgform.observacao }}
            </div>
          </div>
          <div class="text-end mt-3">
            <button class="btn btn-primary">Confirmar pagamento</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-header">Histórico de pagamentos</div>
  <table class="table mb-0">
    <thead>
      <tr>
        <th>Data</th>
        <th>Valor</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for p in conta.pagamentos.all %}
      <tr>
        <td>{{ p.data|date:'d/m/Y H:i' }}</td>
        <td>R$ {{ p.valor|floatformat:2 }}</td>
        <td class="text-end">
          <a class="btn btn-sm btn-outline-secondary" target="_blank"
            href="{% url 'carteira:recibo_pagamento' p.id %}?print=1"
            target="_blank"
            rel="noopener"
            title="Imprimir recibo pagamento">
            Recibo</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="3" class="text-muted">Sem pagamentos</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>
{% endblock %}